<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TimeWellth V47 (Fixed)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .brand-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        button { touch-action: manipulation; }
        
        /* Ëµ§Á∑öÔºàÁèæÂú®ÊôÇÂàªÔºâ */
        .current-time-line { 
            position: absolute; 
            left: 0; 
            right: 0; 
            border-top: 2px solid #ef4444; 
            z-index: 50; 
            pointer-events: none; 
        }
        .current-time-ball {
            position: absolute;
            left: -6px;
            top: -5px;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
        }

        /* Ê®©Èôê„Éê„ÉÉ„Ç∏ */
        .badge { font-size: 10px; padding: 2px 8px; border-radius: 99px; color: white; font-weight: bold; letter-spacing: 0.05em; display: inline-block; }
        .badge-master { background-color: #ef4444; }
        .badge-premium { background-color: #f59e0b; }
        .badge-standard { background-color: #94a3b8; }

        /* 3ÊÆµÈöé„Çπ„Ç§„ÉÉ„ÉÅ */
        .role-switch { display: inline-flex; background: #f1f5f9; border-radius: 6px; padding: 2px; border: 1px solid #cbd5e1; }
        .role-btn { 
            padding: 4px 8px; 
            font-size: 10px; 
            font-weight: bold; 
            border-radius: 4px; 
            cursor: pointer; 
            color: #64748b; 
            transition: all 0.1s;
            margin: 0 1px;
        }
        .role-btn:hover { background: #e2e8f0; }
        .role-btn.active { background: white; color: #0f172a; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .role-btn.active-master { color: #ef4444; border-bottom: 2px solid #ef4444; }
        .role-btn.active-premium { color: #f59e0b; border-bottom: 2px solid #f59e0b; }
        .role-btn.active-standard { color: #64748b; border-bottom: 2px solid #94a3b8; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#666;">
            <div style="font-weight:bold; font-size:20px; margin-bottom:10px;">TimeWellth</div>
            <div>Starting...</div>
        </div>
    </div>

    <script type="text/babel">
        // 1. Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyA8WmG0d4w_H3PFIOC3oENuuCnD3AEFY2w",
          authDomain: "timewellth.firebaseapp.com",
          projectId: "timewellth",
          storageBucket: "timewellth.firebasestorage.app",
          messagingSenderId: "950469975192",
          appId: "1:950469975192:web:f7d87a9a8ed12784a5c4ed"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        const { useState, useEffect, useRef, useMemo } = React;

        // 2. Constants
        const MASTER_EMAIL = "kentaro.honma@genova.co.jp";

        const CATEGORIES = [
            { id: 'meeting', name: '‰ºöË≠∞/ÊâìÂêà„Åõ', color: 'bg-blue-500', code: '#3b82f6' },
            { id: 'sales', name: 'ÂïÜË´á/Ë®™Âïè', color: 'bg-red-500', code: '#ef4444' },
            { id: 'call', name: '„ÉÜ„É¨„Ç¢„Éù', color: 'bg-pink-400', code: '#f472b6' },
            { id: 'doc', name: 'Ë≥áÊñô‰ΩúÊàê/‰∫ãÂãô', color: 'bg-yellow-400', code: '#facc15' },
            { id: 'task', name: '‰ΩúÊ•≠', color: 'bg-purple-500', code: '#a855f7' },
            { id: 'travel', name: 'ÁßªÂãï', color: 'bg-green-500', code: '#22c55e' },
            { id: 'learning', name: 'Â≠¶Áøí', color: 'bg-orange-400', code: '#fb923c' },
            { id: 'break', name: '‰ºëÊÜ©', color: 'bg-gray-100 border border-gray-300 text-black', code: '#f3f4f6' },
            { id: 'private', name: '„Éó„É©„Ç§„Éô„Éº„Éà', color: 'bg-gray-900', code: '#111827' },
        ];

        const TIME_SLOTS = [];
        for (let h = 8; h <= 22; h++) {
            TIME_SLOTS.push(`${h.toString().padStart(2, '0')}:00`);
            TIME_SLOTS.push(`${h.toString().padStart(2, '0')}:30`);
        }

        const formatDate = (date) => `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        const getDisplayDate = (dateStr) => {
            const d = new Date(dateStr);
            const days = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
            return `${d.getMonth()+1}Êúà${d.getDate()}Êó•(${days[d.getDay()]})`;
        };
        const getTodayFullDate = () => {
            const d = new Date();
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        };

        const getRankInfo = (totalDays) => {
            if (totalDays >= 300) return { id: 'gold', name: 'Gold', color: 'bg-gradient-to-r from-yellow-300 to-yellow-500', text: 'text-yellow-600', icon: 'üëë', next: null, target: 300 };
            if (totalDays >= 100) return { id: 'silver', name: 'Silver', color: 'bg-gradient-to-r from-gray-200 to-gray-400', text: 'text-gray-600', icon: 'ü•à', next: 'Gold', target: 300 };
            if (totalDays >= 30) return { id: 'bronze', name: 'Bronze', color: 'bg-gradient-to-r from-orange-200 to-orange-400', text: 'text-orange-700', icon: 'ü•â', next: 'Silver', target: 100 };
            return { id: 'beginner', name: 'Beginner', color: 'bg-gradient-to-r from-green-200 to-green-400', text: 'text-green-700', icon: 'üî∞', next: 'Bronze', target: 30 };
        };

        // 3. Hooks
        const useFirebaseData = () => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [allData, setAllData] = useState({});
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubAuth = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        db.collection("users").doc(u.uid).onSnapshot(doc => {
                            if (doc.exists) {
                                const d = doc.data();
                                if (u.email === MASTER_EMAIL && d.role !== 'master') {
                                    db.collection("users").doc(u.uid).update({ role: 'master' });
                                }
                                setUserData(d);
                            } else {
                                const initialRole = u.email === MASTER_EMAIL ? 'master' : 'standard';
                                db.collection("users").doc(u.uid).set({
                                    name: u.displayName || "No Name", email: u.email, role: initialRole, teamMembers: [], createdAt: new Date()
                                }, { merge: true });
                            }
                        });
                        db.collection("users").doc(u.uid).collection("data").doc("logs").onSnapshot(doc => {
                            setAllData(doc.exists ? (doc.data().data || {}) : {});
                        });
                    } else {
                        setUser(null); setUserData(null); setAllData({});
                    }
                    setLoading(false);
                });
                return () => unsubAuth();
            }, []);

            const saveData = async (newData, targetUid = null) => {
                const uid = targetUid || user.uid;
                await db.collection("users").doc(uid).collection("data").doc("logs").set({ data: newData }, { merge: true });
            };

            const searchUsers = async (query) => {
                const snapshot = await db.collection("users").get();
                const users = [];
                snapshot.forEach(doc => users.push({ uid: doc.id, ...doc.data() }));
                return users.filter(u => u.name.includes(query) || (u.email && u.email.includes(query)));
            };

            const addTeamMember = async (memberUid) => {
                if (!userData.teamMembers?.includes(memberUid)) {
                    const newMembers = [...(userData.teamMembers || []), memberUid];
                    await db.collection("users").doc(user.uid).update({ teamMembers: newMembers });
                }
            };

            const removeTeamMember = async (memberUid) => {
                const newMembers = userData.teamMembers.filter(id => id !== memberUid);
                await db.collection("users").doc(user.uid).update({ teamMembers: newMembers });
            };

            const fetchMemberData = async (uid) => {
                const userDoc = await db.collection("users").doc(uid).get();
                const logDoc = await db.collection("users").doc(uid).collection("data").doc("logs").get();
                return { info: userDoc.data(), logs: logDoc.exists ? logDoc.data().data : {} };
            };

            const updateUserRole = async (uid, newRole) => {
                await db.collection("users").doc(uid).update({ role: newRole });
            };

            const loginGoogle = async () => { try { await auth.signInWithPopup(googleProvider); } catch(e) { alert(e.message); } };
            const logout = async () => { if(confirm("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü")) await auth.signOut(); };

            return { user, userData, allData, loading, saveData, searchUsers, addTeamMember, removeTeamMember, fetchMemberData, updateUserRole, loginGoogle, logout };
        };

        // 4. Components

        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen brand-gradient flex flex-col items-center justify-center p-6 text-white animate-fade-in">
                <div className="bg-white/10 backdrop-blur-lg p-10 rounded-3xl border border-white/20 shadow-2xl max-w-sm w-full text-center">
                    <h1 className="text-3xl font-black mb-2">TimeWellth</h1>
                    <p className="text-blue-100 mb-8 text-sm">„ÅÇ„Å™„Åü„ÅÆË°åÂãï„ÇíË≥áÁî£„Å´Â§â„Åà„Çã</p>
                    <button onClick={onLogin} className="w-full bg-white text-gray-700 font-bold py-3 rounded-xl shadow-lg hover:bg-gray-50 transition transform hover:scale-105 flex items-center justify-center gap-3">
                        <i className="fab fa-google"></i> Google„Åß„É≠„Ç∞„Ç§„É≥
                    </button>
                </div>
            </div>
        );

        const SetupScreen = () => <div className="h-screen flex items-center justify-center">Setting up...</div>;

        const RoleBadge = ({ role }) => {
            const labels = { master: "MASTER", premium: "PREMIUM", standard: "STANDARD" };
            const styles = { master: "badge-master", premium: "badge-premium", standard: "badge-standard" };
            const safeRole = role && labels[role] ? role : 'standard';
            return <span className={`badge ${styles[safeRole]}`}>{labels[safeRole]}</span>;
        };

        const RoleSwitch = ({ currentRole, onChange }) => {
            const roles = [
                { id: 'standard', label: 'Std' },
                { id: 'premium', label: 'Pre' },
                { id: 'master', label: 'Mst' }
            ];
            const safeCurrent = currentRole || 'standard';
            return (
                <div className="role-switch">
                    {roles.map(r => (
                        <div 
                            key={r.id}
                            onClick={() => onChange(r.id)}
                            className={`role-btn ${safeCurrent === r.id ? 'active active-' + r.id : ''}`}
                        >
                            {r.label}
                        </div>
                    ))}
                </div>
            );
        };

        const AnalyticsModal = ({ onClose, allData, viewDate }) => {
            const [activeTab, setActiveTab] = useState('week'); 
            const canvasRef = useRef(null); const chartInstance = useRef(null);

            const stats = useMemo(() => {
                const result = {}; CATEGORIES.forEach(c => result[c.id] = 0);
                let startDate, endDate;
                if (activeTab === 'week') {
                    const today = new Date(); const day = today.getDay();
                    startDate = new Date(today); startDate.setDate(today.getDate() - day); 
                    endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); 
                } else {
                    startDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
                    endDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0);
                }
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dStr = formatDate(d); const dayData = allData[dStr];
                    if (dayData && dayData.actuals) {
                        Object.values(dayData.actuals).forEach(item => { if (result[item.cat] !== undefined) result[item.cat] += 0.5; });
                    }
                }
                return result;
            }, [activeTab, allData, viewDate]);

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const dataValues = Object.values(stats); const labels = CATEGORIES.map(c => c.name); const colors = CATEGORIES.map(c => c.code);
                    const filteredData = [], filteredLabels = [], filteredColors = [];
                    dataValues.forEach((val, i) => { if (val > 0) { filteredData.push(val); filteredLabels.push(labels[i]); filteredColors.push(colors[i]); } });
                    const ctx = canvasRef.current.getContext('2d');
                    if (filteredData.length === 0) { ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height); return; }
                    chartInstance.current = new Chart(ctx, { type: 'doughnut', data: { labels: filteredLabels, datasets: [{ data: filteredData, backgroundColor: filteredColors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${c.label}: ${c.raw}h` } } }, cutout: '60%' } });
                }
            }, [stats]);

            const totalHours = Object.values(stats).reduce((a, b) => a + b, 0);
            const exportAnalysisCSV = () => {
                let csvContent = "\uFEFFÈõÜË®àÊúüÈñì,„Ç´„ÉÜ„Ç¥„É™„Éº,ÂêàË®àÊôÇÈñì(h),ÊßãÊàêÊØî(%)\n";
                const periodLabel = activeTab === 'week' ? "‰ªäÈÄ±" : `${viewDate.getFullYear()}Âπ¥${viewDate.getMonth()+1}Êúà`;
                CATEGORIES.forEach(cat => { const hours = stats[cat.id]; if (hours > 0) { const percent = Math.round((hours / totalHours) * 100); csvContent += `${periodLabel},${cat.name},${hours},${percent}\n`; } });
                if (totalHours === 0) { alert("ÈõÜË®à„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"); return; }
                const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csvContent); link.download = `timewealth_analysis_${activeTab}_${getTodayFullDate()}.csv`; document.body.appendChild(link); link.click();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end md:items-center justify-center z-50">
                    <div className="bg-white w-full max-w-md md:max-w-lg rounded-t-2xl md:rounded-2xl p-6 animate-slide-up max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-gray-700">üìä ÂàÜÊûê„É¨„Éù„Éº„Éà</h3><button onClick={onClose} className="bg-gray-100 w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200">√ó</button></div>
                        <div className="flex bg-gray-100 p-1 rounded-lg mb-6">
                            <button onClick={() => setActiveTab('week')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${activeTab === 'week' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}>‰ªäÈÄ±</button>
                            <button onClick={() => setActiveTab('month')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${activeTab === 'month' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}>{viewDate.getMonth()+1}ÊúàÂ∫¶</button>
                        </div>
                        <div className="relative h-48 w-full flex justify-center items-center mb-6">{totalHours > 0 ? (<><canvas ref={canvasRef}></canvas><div className="absolute text-center"><p className="text-xs text-gray-400">Total</p><p className="text-2xl font-bold">{totalHours}<span className="text-sm">h</span></p></div></>) : (<p className="text-gray-400 text-sm">„Éá„Éº„Çø„Å™„Åó</p>)}</div>
                        <div className="space-y-2 overflow-y-auto flex-1 mb-4">
                            {CATEGORIES.map(cat => {
                                const hours = stats[cat.id]; if (hours === 0) return null; const percent = Math.round((hours / totalHours) * 100);
                                return (<div key={cat.id} className="flex items-center justify-between p-2 hover:bg-gray-50 rounded"><div className="flex items-center gap-2"><div className={`w-3 h-3 rounded-full ${cat.color}`}></div><span className="text-sm font-medium">{cat.name}</span></div><div className="text-right"><span className="font-bold mr-2">{hours}h</span><span className="text-xs text-gray-400">({percent}%)</span></div></div>);
                            })}
                        </div>
                        <button onClick={exportAnalysisCSV} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold">CSVÂá∫Âäõ</button>
                    </div>
                </div>
            );
        };

        const TeamScreen = ({ user, userData, searchUsers, addTeamMember, removeTeamMember, onViewMembers }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            const [teamList, setTeamList] = useState([]);
            const [selectedMembers, setSelectedMembers] = useState([]);

            useEffect(() => {
                const loadTeam = async () => {
                    if (userData.teamMembers && userData.teamMembers.length > 0) {
                        const promises = userData.teamMembers.map(uid => db.collection("users").doc(uid).get());
                        const docs = await Promise.all(promises);
                        setTeamList(docs.map(d => ({ uid: d.id, ...d.data() })));
                    } else { setTeamList([]); }
                };
                loadTeam();
            }, [userData.teamMembers]);

            const handleSearch = async () => {
                if(!searchTerm) return;
                const res = await searchUsers(searchTerm);
                setSearchResults(res.filter(u => u.uid !== user.uid));
            };

            const toggleSelect = (uid) => {
                if (selectedMembers.includes(uid)) setSelectedMembers(selectedMembers.filter(id => id !== uid));
                else setSelectedMembers([...selectedMembers, uid]);
            };

            return (
                <div className="p-4 pb-24 max-w-5xl mx-auto w-full">
                    <h2 className="font-bold text-xl mb-4 text-gray-700">„ÉÅ„Éº„É†ÁÆ°ÁêÜ</h2>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-6">
                        <div className="flex gap-2 mb-2">
                            <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="flex-1 border p-2 rounded text-sm" placeholder="ÂêçÂâç/„É°„Éº„É´„ÅßÊ§úÁ¥¢" />
                            <button onClick={handleSearch} className="bg-blue-600 text-white px-4 rounded text-sm font-bold">Ê§úÁ¥¢</button>
                        </div>
                        {searchResults.length > 0 && (
                            <ul className="border rounded divide-y text-sm">
                                {searchResults.map(u => (
                                    <li key={u.uid} className="p-2 flex justify-between items-center">
                                        <span>{u.name}</span>
                                        <button onClick={() => { addTeamMember(u.uid); setSearchResults([]); setSearchTerm(""); }} className="text-blue-600 font-bold">+ ËøΩÂä†</button>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-sm">„É°„É≥„Éê„Éº ({teamList.length})</h3>
                            <button onClick={() => onViewMembers(selectedMembers)} disabled={selectedMembers.length===0} className={`px-3 py-1 rounded text-xs font-bold text-white ${selectedMembers.length>0?'bg-green-600':'bg-gray-300'}`}>Ë°®Á§∫</button>
                        </div>
                        <ul className="divide-y text-sm">
                            {teamList.map(member => (
                                <li key={member.uid} className="py-3 flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <input type="checkbox" checked={selectedMembers.includes(member.uid)} onChange={() => toggleSelect(member.uid)} />
                                        <div><div className="font-bold">{member.name}</div><div className="text-xs text-gray-400">{member.email}</div></div>
                                    </div>
                                    <button onClick={() => removeTeamMember(member.uid)} className="text-red-400 text-xs">Ëß£Èô§</button>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            );
        };

        const AdminScreen = ({ searchUsers, updateUserRole, currentUserUid }) => {
            const [users, setUsers] = useState([]);
            useEffect(() => { searchUsers("").then(setUsers); }, []);
            
            const handleRoleChange = async (uid, newRole, name) => {
                if (uid === currentUserUid) { alert("Ëá™ÂàÜËá™Ë∫´„ÅÆÊ®©Èôê„ÅØÂ§âÊõ¥„Åß„Åç„Åæ„Åõ„Çì"); return; }
                if (confirm(`${name}„Åï„Çì„ÅÆÊ®©Èôê„Çí„Äê${newRole.toUpperCase()}„Äë„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü`)) {
                    await updateUserRole(uid, newRole);
                    setUsers(users.map(u => u.uid === uid ? { ...u, role: newRole } : u));
                }
            };

            return (
                <div className="p-4 pb-24 max-w-5xl mx-auto w-full">
                    <h2 className="font-bold text-xl mb-4 text-gray-700">„Ç¢„Ç´„Ç¶„É≥„ÉàÁÆ°ÁêÜ</h2>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden text-sm">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 text-gray-600"><tr><th className="p-3">ÂêçÂâç</th><th className="p-3">Ê®©Èôê</th><th className="p-3 text-center">Êìç‰Ωú</th></tr></thead>
                            <tbody className="divide-y">
                                {users.map(u => (
                                    <tr key={u.uid}>
                                        <td className="p-3">{u.name}<div className="text-xs text-gray-400">{u.email}</div></td>
                                        <td className="p-3"><RoleBadge role={u.role} /></td>
                                        <td className="p-3 text-center">
                                            {u.uid !== currentUserUid ? (
                                                <RoleSwitch 
                                                    currentRole={u.role} 
                                                    onChange={(r) => handleRoleChange(u.uid, r, u.name)} 
                                                />
                                            ) : (
                                                <span className="text-xs text-gray-300">Êìç‰Ωú‰∏çÂèØ</span>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const MultiViewScreen = ({ targetUids, fetchMemberData, saveData }) => {
            const [membersData, setMembersData] = useState([]);
            const [currentDate, setCurrentDate] = useState(formatDate(new Date()));

            useEffect(() => {
                Promise.all(targetUids.map(uid => fetchMemberData(uid))).then(data => {
                    setMembersData(data.map((d, i) => ({ ...d, uid: targetUids[i] })));
                });
            }, [targetUids, currentDate]);

            const changeDate = (diff) => { const d = new Date(currentDate); d.setDate(d.getDate() + diff); setCurrentDate(formatDate(d)); };
            const saveComment = async (targetUid, comment) => {
                const targetMember = membersData.find(m => m.uid === targetUid);
                const dayLog = targetMember.logs[currentDate] || {};
                await saveData({ ...dayLog, supervisorComment: comment }, targetUid);
                alert("‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
            };

            return (
                <div className="flex flex-col h-full overflow-hidden">
                    <div className="bg-white p-3 border-b flex justify-between items-center shadow-sm z-10 shrink-0">
                        <button onClick={() => changeDate(-1)} className="p-2"><i className="fas fa-chevron-left"></i></button>
                        <h2 className="font-bold">{currentDate}</h2>
                        <button onClick={() => changeDate(1)} className="p-2"><i className="fas fa-chevron-right"></i></button>
                    </div>
                    <div className="flex-1 overflow-x-auto bg-[#f8fafc]">
                        <div className="flex h-full" style={{ minWidth: membersData.length > 1 ? membersData.length * 320 + 'px' : '100%' }}>
                            {membersData.map(member => {
                                const dayLog = member.logs[currentDate] || {};
                                return (
                                    <div key={member.uid} className={`${membersData.length === 1 ? 'flex-1' : 'w-80'} border-r flex flex-col h-full bg-white shrink-0`}>
                                        <div className="p-2 bg-gray-50 border-b font-bold text-center text-blue-900 sticky top-0">{member.info.name}</div>
                                        <div className="flex-1 overflow-y-auto p-2">
                                            {TIME_SLOTS.map(time => (
                                                <div key={time} className="flex border-b h-12 text-xs items-center">
                                                    <div className="w-12 text-gray-400 border-r pr-2">{time}</div>
                                                    <div className="flex-1 px-2">{dayLog.actuals?.[time] && <span className={`block w-full py-1 px-2 rounded text-white ${CATEGORIES.find(c=>c.id===dayLog.actuals[time].cat)?.color}`}>{dayLog.actuals[time].text}</span>}</div>
                                                </div>
                                            ))}
                                            <div className="mt-4 border-t pt-4 space-y-4 pb-20">
                                                <div className="bg-blue-50 p-3 rounded-lg"><div className="font-bold text-xs text-blue-600 mb-1">AM</div><div className="text-sm">{dayLog.reflection?.am || '-'}</div></div>
                                                <div className="bg-indigo-50 p-3 rounded-lg"><div className="font-bold text-xs text-indigo-600 mb-1">PM</div><div className="text-sm">{dayLog.reflection?.pm || '-'}</div></div>
                                                <div className="bg-green-50 p-3 rounded-lg border border-green-200">
                                                    <div className="font-bold text-xs text-green-700 mb-2">‰∏äÂè∏„Ç≥„É°„É≥„Éà</div>
                                                    <textarea id={`cmt-${member.uid}`} className="w-full text-sm border rounded p-2" rows="3" defaultValue={dayLog.supervisorComment || ""}></textarea>
                                                    <button onClick={() => saveComment(member.uid, document.getElementById(`cmt-${member.uid}`).value)} className="mt-2 w-full bg-green-600 text-white text-sm py-2 rounded font-bold hover:bg-green-700 transition">ÈÄÅ‰ø°</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const HomeScreen = ({ user, todayStr, allData, onViewChange }) => {
            const totalLogs = useMemo(() => {
                if (!allData) return 0;
                return Object.keys(allData).filter(k => allData[k].actuals && Object.keys(allData[k].actuals).length > 0).length;
            }, [allData]);
            const rank = getRankInfo(totalLogs);
            const isPremium = user.role === 'master' || user.role === 'premium';
            const isMaster = user.role === 'master';

            return (
                <div className="p-4 pb-24 md:p-8 animate-fade-in max-w-5xl mx-auto w-full">
                    <div className={`rounded-2xl p-6 md:p-10 text-white shadow-xl mb-8 relative overflow-hidden ${rank.id === 'gold' ? 'bg-gradient-to-br from-yellow-600 to-yellow-400' : 'brand-gradient'}`}>
                        <div className="absolute top-0 right-0 p-4 opacity-10 text-6xl md:text-9xl"><i className="fas fa-chart-line"></i></div>
                        <div className="flex flex-col md:flex-row justify-between items-start gap-6 relative z-10">
                            <div><h2 className="text-2xl font-bold mb-2">„Åì„Çì„Å´„Å°„ÅØ„ÄÅ{user.name}„Åï„Çì</h2><p className="text-white/90 text-sm font-medium">{getDisplayDate(todayStr)}</p></div>
                            <div className="bg-white/95 backdrop-blur rounded-xl p-5 text-gray-800 shadow-lg w-full md:w-80">
                                <div className="flex justify-between items-center mb-2"><span className="text-[10px] font-bold text-gray-400 tracking-wider">CURRENT RANK</span><span className="text-[10px] font-bold text-gray-400 tracking-wider">TOTAL LOGS</span></div>
                                <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><span className="text-3xl">{rank.icon}</span><span className={`text-2xl font-black ${rank.text}`}>{rank.name}</span></div><div className="text-right"><span className="text-3xl font-bold">{totalLogs}</span><span className="text-xs text-gray-500 font-bold"> days</span></div></div>
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4 mb-8">
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100"><p className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wide">Streak</p><p className="text-2xl font-bold text-slate-700">1 <span className="text-xs text-slate-400">days</span></p></div>
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100"><p className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wide">Logs</p><p className="text-2xl font-bold text-slate-700">{totalLogs} <span className="text-xs text-slate-400">days</span></p></div>
                        
                        {isPremium && (
                            <div onClick={() => onViewChange('team')} className="bg-green-50 p-5 rounded-xl shadow-sm border border-green-100 cursor-pointer col-span-2 flex items-center justify-between hover:bg-green-100 transition">
                                <div><p className="text-xs text-green-600 font-bold mb-1 uppercase">Management</p><p className="text-lg font-bold text-green-800">„ÉÅ„Éº„É†„ÅÆË°åÂãïË®òÈå≤</p></div>
                                <i className="fas fa-users text-2xl text-green-300"></i>
                            </div>
                        )}
                        {isMaster && (
                            <div onClick={() => onViewChange('admin')} className="bg-gray-50 p-5 rounded-xl shadow-sm border border-gray-200 cursor-pointer col-span-2 flex items-center justify-between hover:bg-gray-100 transition">
                                <div><p className="text-xs text-gray-500 font-bold mb-1 uppercase">Admin</p><p className="text-lg font-bold text-gray-800">„Ç¢„Ç´„Ç¶„É≥„ÉàÁÆ°ÁêÜ</p></div>
                                <i className="fas fa-cog text-2xl text-gray-300"></i>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const DailyScreen = ({ user, currentDate, setCurrentDate, allData, setAllData, onSlotClick, onSaveReflection, isReflectOpen, setIsReflectOpen }) => {
            const chartRef = useRef(null); const canvasRef = useRef(null); const scrollRef = useRef(null);
            const [currentTimePosition, setCurrentTimePosition] = useState(null);
            const dayData = allData[currentDate] || { actuals: {}, plans: {}, reflection: { am: "", pm: "" } };
            const { actuals, plans, reflection, supervisorComment } = dayData;
            
            useEffect(() => {
                const updatePos = () => {
                    const now = new Date();
                    if (formatDate(now) !== currentDate) { setCurrentTimePosition(null); return; }
                    const h = now.getHours(); const m = now.getMinutes();
                    if(h < 8 || h > 22) { setCurrentTimePosition(null); return; }
                    setCurrentTimePosition(((h - 8) * 60 + m) * (56 / 30) + 36);
                };
                updatePos();
                const timer = setInterval(updatePos, 60000);
                return () => clearInterval(timer);
            }, [currentDate]);

            useEffect(() => { if (canvasRef.current) { if (chartRef.current) chartRef.current.destroy(); const counts = {}; CATEGORIES.forEach(c => counts[c.name] = 0); Object.values(actuals || {}).forEach(item => { const cat = CATEGORIES.find(c => c.id === item.cat); if (cat) counts[cat.name] += 30; }); const ctx = canvasRef.current.getContext('2d'); chartRef.current = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(counts).map(k => k.substring(0,4)), datasets: [{ label: 'ÊôÇÈñì(ÂàÜ)', data: Object.values(counts), backgroundColor: CATEGORIES.map(c => c.code), borderRadius: 4, barThickness: 20 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: true, grid: {display: false} }, y: { display: true, beginAtZero: true } } } }); } }, [actuals]);

            const changeDate = (diff) => { const d = new Date(currentDate); d.setDate(d.getDate() + diff); setCurrentDate(formatDate(d)); };
            const handleSaveReflect = () => { onSaveReflection(document.getElementById('am-area').value, document.getElementById('pm-area').value); setIsReflectOpen(false); };
            const exportCSV = () => { let csvContent = "\uFEFFÊó•‰ªò,Á§æÂì°Âêç,ÊôÇÈñìÂ∏Ø,„Ç´„ÉÜ„Ç¥„É™„Éº,ÂÜÖÂÆπË©≥Á¥∞\n"; const sortedTimes = TIME_SLOTS.filter(t => actuals?.[t]); if (sortedTimes.length === 0) { alert("„Éá„Éº„Çø„Å™„Åó"); return; } sortedTimes.forEach(time => { const rec = actuals[time]; const cat = CATEGORIES.find(c => c.id === rec.cat); csvContent += `${currentDate},${user.name},${time},${cat ? cat.name : "‰∏çÊòé"},"${rec.text}"\n`; }); const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csvContent); link.download = `log_${currentDate}.csv`; document.body.appendChild(link); link.click(); };

            return (
                <div className="flex flex-col h-full relative">
                    <div className="flex items-center justify-between bg-white p-3 border-b shadow-sm z-30 shrink-0"><button onClick={() => changeDate(-1)} className="p-2"><i className="fas fa-chevron-left"></i></button><h2 className="font-bold text-lg">{getDisplayDate(currentDate)}</h2><button onClick={() => changeDate(1)} className="p-2"><i className="fas fa-chevron-right"></i></button></div>
                    <div className="bg-white p-4 shadow-sm border-b z-10 shrink-0 h-48 md:h-64"><canvas ref={canvasRef}></canvas></div>
                    <div className="flex-1 overflow-y-auto relative bg-[#f8fafc]" ref={scrollRef}>
                        {currentTimePosition && <div className="current-time-line" style={{ top: `${currentTimePosition}px` }}><div className="current-time-ball"></div></div>}
                        <div className="flex text-xs md:text-sm font-bold text-gray-500 bg-gray-50 py-3 sticky top-0 z-10 border-b"><div className="w-12 md:w-20 text-center">Time</div><div className="flex-1 text-center">Plan</div><div className="flex-1 text-center">Actual</div></div>
                        {TIME_SLOTS.map(time => (
                            <div key={time} className="flex border-b border-gray-200 h-14 bg-white relative hover:bg-gray-50 transition">
                                <div className="w-12 md:w-20 text-xs md:text-sm text-gray-400 flex justify-center items-start pt-1 border-r border-gray-100 bg-gray-50 shrink-0">{time}</div>
                                <div className="flex-1 p-1 border-r border-gray-100 cursor-pointer relative group" onClick={() => onSlotClick(time, 'plan')}>{plans?.[time] ? <div className={`h-full rounded px-2 py-1 text-[10px] md:text-xs text-white leading-tight flex items-center ${CATEGORIES.find(c=>c.id===plans[time].cat)?.color}`}>{plans[time].text}</div> : <div className="h-full flex items-center justify-center text-gray-100 text-lg group-hover:text-gray-300 transition">+</div>}</div>
                                <div className="flex-1 p-1 cursor-pointer relative group" onClick={() => onSlotClick(time, 'actual')}>{actuals?.[time] ? <div className={`h-full rounded px-2 py-1 text-[10px] md:text-xs text-white leading-tight flex items-center ${CATEGORIES.find(c=>c.id===actuals[time].cat)?.color}`}>{actuals[time].text}</div> : <div className="h-full flex items-center justify-center text-gray-100 text-lg group-hover:text-gray-300 transition">+</div>}</div>
                            </div>
                        ))}
                        {supervisorComment && <div className="m-4 p-4 bg-green-50 border border-green-200 rounded-xl"><div className="font-bold text-green-700 text-sm mb-1"><i className="fas fa-comment-dots"></i> ‰∏äÂè∏„Ç≥„É°„É≥„Éà</div><p className="text-sm text-gray-800">{supervisorComment}</p></div>}
                        <div className="h-24"></div>
                    </div>
                    <div className="absolute bottom-6 right-6 md:bottom-10 md:right-10 flex flex-col gap-3 items-end z-30">
                        <button onClick={exportCSV} className="bg-white text-green-600 border border-green-200 rounded-full w-12 h-12 shadow-lg flex items-center justify-center hover:bg-green-50 transition"><i className="fas fa-file-csv text-xl"></i></button>
                        <button onClick={() => setIsReflectOpen(true)} className="bg-blue-600 text-white rounded-full px-6 py-4 shadow-lg font-bold flex items-center gap-2 hover:bg-blue-700 transition transform hover:scale-105"><i className="fas fa-edit"></i> Êó•Â†±</button>
                    </div>
                    {isReflectOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end md:items-center justify-center">
                            <div className="bg-white w-full max-w-md md:max-w-lg rounded-t-2xl md:rounded-2xl p-6 animate-slide-up max-h-[85vh] overflow-y-auto shadow-2xl">
                                <div className="flex justify-between items-center mb-6 border-b pb-2"><h3 className="font-bold text-xl text-gray-700">üìù Êó•Â†±</h3><button onClick={() => setIsReflectOpen(false)} className="bg-gray-100 w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200">√ó</button></div>
                                <div className="space-y-5">
                                    <div><label className="text-sm font-bold text-blue-600 block mb-2">‚òÄÔ∏è AM</label><textarea id="am-area" className="w-full text-sm p-3 rounded-lg border border-blue-200 bg-blue-50 focus:ring-2 focus:ring-blue-500 outline-none" rows="3" defaultValue={reflection?.am}></textarea></div>
                                    <div><label className="text-sm font-bold text-indigo-600 block mb-2">üåô PM</label><textarea id="pm-area" className="w-full text-sm p-3 rounded-lg border border-indigo-200 bg-indigo-50 focus:ring-2 focus:ring-indigo-500 outline-none" rows="4" defaultValue={reflection?.pm}></textarea></div>
                                    <button onClick={handleSaveReflect} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold mt-2 hover:bg-slate-900 transition">‰øùÂ≠ò</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryScreen = ({ currentDate, setCurrentDate, allData, onSelectDate }) => {
            const [viewDate, setViewDate] = useState(new Date(currentDate));
            const [showAnalytics, setShowAnalytics] = useState(false);
            const changeMonth = (diff) => { const d = new Date(viewDate); d.setMonth(d.getMonth() + diff); setViewDate(d); };
            const generateCalendar = () => { const year = viewDate.getFullYear(); const month = viewDate.getMonth(); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const days = []; for (let i = 0; i < firstDay.getDay(); i++) { days.push(null); } for (let i = 1; i <= lastDay.getDate(); i++) { days.push(new Date(year, month, i)); } return days; };
            const calendarDays = generateCalendar();

            return (
                <div className="p-4 pb-24 md:p-8 animate-fade-in max-w-5xl mx-auto w-full">
                    <div className="flex justify-between items-end mb-4">
                        <h2 className="font-bold text-gray-700 text-xl">Â±•Ê≠¥</h2>
                        <button onClick={() => setShowAnalytics(true)} className="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full text-sm font-bold shadow-sm hover:bg-indigo-100 transition"><i className="fas fa-chart-pie mr-2"></i>ÂàÜÊûê</button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
                        <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">{viewDate.getFullYear()}Âπ¥ {viewDate.getMonth() + 1}Êúà</h3><div className="flex gap-2 text-gray-500"><button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded"><i className="fas fa-chevron-left"></i></button><button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded"><i className="fas fa-chevron-right"></i></button></div></div>
                        <div className="grid grid-cols-7 gap-2 text-center text-sm mb-2 text-gray-400 font-bold"><div>Êó•</div><div>Êúà</div><div>ÁÅ´</div><div>Ê∞¥</div><div>Êú®</div><div>Èáë</div><div>Âúü</div></div>
                        <div className="grid grid-cols-7 gap-2 text-center text-sm">
                            {calendarDays.map((date, i) => {
                                if (!date) return <div key={i}></div>;
                                const dateStr = formatDate(date);
                                const hasData = allData[dateStr] && Object.keys(allData[dateStr].actuals || {}).length > 0;
                                const isSelected = dateStr === currentDate;
                                return (<div key={i} onClick={() => onSelectDate(dateStr)} className={`h-12 md:h-16 flex flex-col items-center justify-center rounded-lg transition cursor-pointer border ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-transparent hover:border-gray-200 hover:bg-gray-50'}`}><span className={`text-sm ${isSelected ? 'font-bold text-blue-600' : 'text-gray-600'}`}>{date.getDate()}</span>{hasData && <div className="flex gap-0.5 mt-1"><div className="w-1.5 h-1.5 rounded-full bg-green-400"></div></div>}</div>);
                            })}
                        </div>
                    </div>
                    {showAnalytics && <AnalyticsModal onClose={() => setShowAnalytics(false)} allData={allData} viewDate={viewDate} />}
                </div>
            );
        };

        const App = () => {
            const { user, userData, allData, loading, saveData, searchUsers, addTeamMember, removeTeamMember, fetchMemberData, updateUserRole, loginGoogle, logout } = useFirebaseData();
            const [view, setView] = useState('home');
            const [currentDate, setCurrentDate] = useState(formatDate(new Date()));
            const [viewMembers, setViewMembers] = useState([]);

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedTime, setSelectedTime] = useState(null);
            const [inputType, setInputType] = useState(null);
            const [inputText, setInputText] = useState("");
            const [isReflectOpen, setIsReflectOpen] = useState(false);

            if (loading) return <div id="loader"><div className="text-xl font-bold text-gray-600 mb-2">TimeWellth</div><div className="text-sm text-gray-400">Loading...</div></div>;
            if (!user) return <LoginScreen onLogin={loginGoogle} />;
            if (!userData) return <div className="h-screen flex items-center justify-center">Account Setup...</div>;

            const isPremium = userData.role === 'master' || userData.role === 'premium';
            const isMaster = userData.role === 'master';

            const handleSave = (catId) => {
                const text = inputText.trim() === "" ? CATEGORIES.find(c => c.id === catId).name : inputText;
                const data = { text, cat: catId };
                const dayData = allData[currentDate] || { plans: {}, actuals: {}, reflection: {} };
                if (inputType === 'plan') dayData.plans = { ...dayData.plans, [selectedTime]: data };
                else dayData.actuals = { ...dayData.actuals, [selectedTime]: data };
                saveData({ ...allData, [currentDate]: dayData });
                setIsModalOpen(false); setInputText("");
            };
            const handleReflection = (am, pm) => {
                const dayData = allData[currentDate] || { plans: {}, actuals: {}, reflection: {} };
                saveData({ ...allData, [currentDate]: { ...dayData, reflection: { am, pm } } });
                setIsReflectOpen(false);
            };
            const handleSlotClick = (time, type) => {
                setSelectedTime(time); setInputType(type);
                const dayData = allData[currentDate] || { plans: {}, actuals: {} };
                const cur = dayData[type === 'plan' ? 'plans' : 'actuals']?.[time];
                setInputText(cur ? cur.text : "");
                setIsModalOpen(true);
            };
            const handleSelectDate = (dateStr) => { setCurrentDate(dateStr); setView('daily'); };
            const handleViewTeam = (uids) => { setViewMembers(uids); setView('multiview'); };

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    <div className={`text-white p-4 flex justify-between items-center shrink-0 z-40 shadow-md brand-gradient`}>
                        <div className="flex items-center gap-2">
                            <h1 className="font-bold text-lg">TimeWellth</h1>
                            <RoleBadge role={userData.role} />
                        </div>
                        <button onClick={logout} className="text-[10px] md:text-xs bg-white/20 px-3 py-1.5 rounded text-white/90 hover:bg-white/30 transition border border-white/10">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    </div>

                    <div className="flex-1 overflow-hidden relative w-full bg-[#f8fafc] md:flex-row flex-col">
                        <div className="hidden md:flex w-64 bg-white border-r flex-col shrink-0 z-30 p-4 gap-2">
                            <button onClick={() => setView('home')} className={`p-3 text-left font-bold rounded transition ${view==='home' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-100'}`}><i className="fas fa-home mr-2"></i>„Éõ„Éº„É†</button>
                            <button onClick={() => { setCurrentDate(formatDate(new Date())); setView('daily'); }} className={`p-3 text-left font-bold rounded transition ${view==='daily' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-100'}`}><i className="fas fa-calendar-day mr-2"></i>Ë°åÂãïË®òÈå≤</button>
                            <button onClick={() => setView('history')} className={`p-3 text-left font-bold rounded transition ${view==='history' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-100'}`}><i className="fas fa-history mr-2"></i>Â±•Ê≠¥</button>
                            {isPremium && <div className="border-t my-2"></div>}
                            {isPremium && <button onClick={() => setView('team')} className={`p-3 text-left font-bold rounded transition ${view==='team' ? 'text-green-600 bg-green-50' : 'text-gray-600 hover:bg-gray-100'}`}><i className="fas fa-users mr-2"></i>„ÉÅ„Éº„É†ÁÆ°ÁêÜ</button>}
                            {isMaster && <button onClick={() => setView('admin')} className={`p-3 text-left font-bold rounded transition ${view==='admin' ? 'text-gray-800 bg-gray-100' : 'text-gray-600 hover:bg-gray-100'}`}><i className="fas fa-cog mr-2"></i>„Ç¢„Ç´„Ç¶„É≥„ÉàÁÆ°ÁêÜ</button>}
                        </div>

                        {/* ‚òÖ‰øÆÊ≠£„Éù„Ç§„É≥„Éà: "block" „Åã„Çâ "flex flex-col justify-start" „Å´Â§âÊõ¥„Åó„Å¶‰∏äË©∞„ÇÅ„ÇíÂº∑Âà∂ */}
                        <div className="flex-1 overflow-y-auto w-full h-full bg-[#f8fafc] flex flex-col justify-start p-0 relative">
                            {view === 'home' && <HomeScreen user={userData} todayStr={formatDate(new Date())} allData={allData} onViewChange={setView} />}
                            {view === 'daily' && <DailyScreen user={userData} currentDate={currentDate} setCurrentDate={setCurrentDate} allData={allData} setAllData={null} onSlotClick={handleSlotClick} onSaveReflection={handleReflection} isReflectOpen={isReflectOpen} setIsReflectOpen={setIsReflectOpen} />}
                            {view === 'history' && <HistoryScreen currentDate={currentDate} setCurrentDate={setCurrentDate} allData={allData} onSelectDate={handleSelectDate} />}
                            {view === 'team' && <TeamScreen user={user} userData={userData} searchUsers={searchUsers} addTeamMember={addTeamMember} removeTeamMember={removeTeamMember} onViewMembers={handleViewTeam} />}
                            {view === 'admin' && <AdminScreen searchUsers={searchUsers} updateUserRole={updateUserRole} currentUserUid={user.uid} />}
                            {view === 'multiview' && <MultiViewScreen targetUids={viewMembers} fetchMemberData={fetchMemberData} saveData={saveData} />}
                        </div>
                    </div>

                    <div className="md:hidden shrink-0 bg-white border-t border-gray-200 flex justify-around py-2 pb-safe z-40">
                        <button onClick={() => setView('home')} className={`flex flex-col items-center p-2 flex-1 ${view === 'home' ? 'text-blue-600' : 'text-gray-400'}`}><i className="fas fa-home text-xl mb-1"></i><span className="text-[10px] font-bold">„Éõ„Éº„É†</span></button>
                        <button onClick={() => { setCurrentDate(formatDate(new Date())); setView('daily'); }} className={`flex flex-col items-center p-2 flex-1 ${view === 'daily' ? 'text-blue-600' : 'text-gray-400'}`}><i className="fas fa-calendar-day text-xl mb-1"></i><span className="text-[10px] font-bold">Ë°åÂãïË®òÈå≤</span></button>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center p-2 flex-1 ${view === 'history' ? 'text-blue-600' : 'text-gray-400'}`}><i className="fas fa-history text-xl mb-1"></i><span className="text-[10px] font-bold">Â±•Ê≠¥</span></button>
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end md:items-center justify-center z-50">
                            <div className="bg-white w-full max-w-md md:max-w-lg rounded-t-2xl md:rounded-2xl p-5 animate-slide-up shadow-2xl">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-700">{selectedTime} „ÅÆ{inputType === 'plan' ? '‰∫àÂÆö' : 'ÂÆüÁ∏æ'}</h3><button onClick={() => setIsModalOpen(false)} className="bg-gray-100 w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200">√ó</button></div>
                                <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} className="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg mb-4 outline-none focus:ring-2 focus:ring-blue-500" placeholder="ÂÜÖÂÆπ„ÇíÂÖ•Âäõ..." autoFocus />
                                <div className="grid grid-cols-3 gap-2">{CATEGORIES.map(cat => <button key={cat.id} onClick={() => handleSave(cat.id)} className={`${cat.color} text-white py-3 rounded-lg text-xs font-bold shadow-sm active:scale-95 transition flex flex-col items-center justify-center hover:opacity-90`}>{cat.name}</button>)}</div>
                            </div>
                        </div>
                    )}
                    {isReflectOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-end justify-center z-50">
                            <div className="bg-white w-full max-w-md rounded-t-2xl p-5">
                                <h3 className="font-bold mb-4">Êó•Â†±</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-blue-600">AM</label><textarea id="am-in" className="w-full border p-2" rows="2" defaultValue={allData[currentDate]?.reflection?.am}></textarea></div>
                                    <div><label className="text-xs font-bold text-indigo-600">PM</label><textarea id="pm-in" className="w-full border p-2" rows="3" defaultValue={allData[currentDate]?.reflection?.pm}></textarea></div>
                                    <button onClick={()=>{handleReflection(document.getElementById('am-in').value, document.getElementById('pm-in').value)}} className="w-full bg-slate-800 text-white py-3 rounded font-bold">‰øùÂ≠ò</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>