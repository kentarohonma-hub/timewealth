<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TimeWellth V38</title>
    
    <div id="debug-console" style="display:none; position:fixed; top:0; left:0; right:0; background:rgba(0,0,0,0.8); color:#ff5555; padding:10px; z-index:9999; font-size:12px; max-height:200px; overflow:auto;"></div>
    <script>
        window.onerror = function(msg, url, line) {
            var el = document.getElementById('debug-console');
            el.style.display = 'block';
            el.innerHTML += "<div>[Error] " + msg + " (Line:" + line + ")</div>";
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .current-time-line { position: absolute; left: 0; right: 0; border-top: 2px solid #ef4444; z-index: 20; pointer-events: none; }
        .brand-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        button { touch-action: manipulation; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#666;">
            <div style="font-weight:bold; font-size:20px; margin-bottom:10px;">TimeWellth</div>
            <div>Starting App...</div>
        </div>
    </div>

    <script type="text/babel">
        // 1. FirebaseåˆæœŸåŒ–
        const firebaseConfig = {
          apiKey: "AIzaSyA8WmG0d4w_H3PFIOC3oENuuCnD3AEFY2w",
          authDomain: "timewellth.firebaseapp.com",
          projectId: "timewellth",
          storageBucket: "timewellth.firebasestorage.app",
          messagingSenderId: "950469975192",
          appId: "1:950469975192:web:f7d87a9a8ed12784a5c4ed"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        const { useState, useEffect, useRef, useMemo } = React;

        // 2. å®šæ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        const CATEGORIES = [
            { id: 'meeting', name: 'ä¼šè­°/æ‰“åˆã›', color: 'bg-blue-500', code: '#3b82f6' },
            { id: 'sales', name: 'å•†è«‡/è¨ªå•', color: 'bg-red-500', code: '#ef4444' },
            { id: 'call', name: 'ãƒ†ãƒ¬ã‚¢ãƒ', color: 'bg-pink-400', code: '#f472b6' },
            { id: 'doc', name: 'è³‡æ–™ä½œæˆ/äº‹å‹™', color: 'bg-yellow-400', code: '#facc15' },
            { id: 'task', name: 'ä½œæ¥­', color: 'bg-purple-500', code: '#a855f7' },
            { id: 'travel', name: 'ç§»å‹•', color: 'bg-green-500', code: '#22c55e' },
            { id: 'learning', name: 'å­¦ç¿’', color: 'bg-orange-400', code: '#fb923c' },
            { id: 'break', name: 'ä¼‘æ†©', color: 'bg-gray-100 border border-gray-300 text-black', code: '#f3f4f6' },
            { id: 'private', name: 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ', color: 'bg-gray-900', code: '#111827' },
        ];

        const TIME_SLOTS = [];
        for (let h = 8; h <= 22; h++) {
            TIME_SLOTS.push(`${h.toString().padStart(2, '0')}:00`);
            TIME_SLOTS.push(`${h.toString().padStart(2, '0')}:30`);
        }

        const formatDate = (date) => `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        const getDisplayDate = (dateStr) => {
            const d = new Date(dateStr);
            const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
            return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${days[d.getDay()]})`;
        };
        const getTodayFullDate = () => {
            const d = new Date();
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        };

        const getRankInfo = (totalDays) => {
            if (totalDays >= 300) return { id: 'gold', name: 'Gold', color: 'bg-gradient-to-r from-yellow-300 to-yellow-500', text: 'text-yellow-600', icon: 'ğŸ‘‘', next: null, target: 300 };
            if (totalDays >= 100) return { id: 'silver', name: 'Silver', color: 'bg-gradient-to-r from-gray-200 to-gray-400', text: 'text-gray-600', icon: 'ğŸ¥ˆ', next: 'Gold', target: 300 };
            if (totalDays >= 30) return { id: 'bronze', name: 'Bronze', color: 'bg-gradient-to-r from-orange-200 to-orange-400', text: 'text-orange-700', icon: 'ğŸ¥‰', next: 'Silver', target: 100 };
            return { id: 'beginner', name: 'Beginner', color: 'bg-gradient-to-r from-green-200 to-green-400', text: 'text-green-700', icon: 'ğŸ”°', next: 'Bronze', target: 30 };
        };

        // 3. ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ•ãƒƒã‚¯
        const useFirebaseData = () => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [allData, setAllData] = useState({});
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubAuth = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        const userRef = db.collection("users").doc(u.uid);
                        userRef.onSnapshot(doc => {
                            if (doc.exists) setUserData(doc.data());
                            else {
                                registerUser(u.displayName || "No Name", u.uid);
                            }
                        });
                        const logsRef = db.collection("users").doc(u.uid).collection("data").doc("logs");
                        logsRef.onSnapshot(doc => {
                            if (doc.exists) setAllData(doc.data().data || {});
                            else setAllData({});
                        });
                    } else {
                        setUser(null);
                        setUserData(null);
                        setAllData({});
                    }
                    setLoading(false);
                });
                return () => unsubAuth();
            }, []);

            const registerUser = async (name, uid) => {
                const targetUid = uid || (user ? user.uid : null);
                if(!targetUid) return;
                // æ³¨æ„: ã“ã“ã§streakã‚„totalDaysã‚’ä¸Šæ›¸ãã›ãšã€ä½œæˆæ—¥ã ã‘è¨˜éŒ²
                await db.collection("users").doc(targetUid).set({
                    name: name, role: 'member', createdAt: new Date()
                }, { merge: true });
            };

            const saveData = async (newData) => {
                if(!user) return;
                await db.collection("users").doc(user.uid).collection("data").doc("logs").set({ data: newData }, { merge: true });
            };

            const loginGoogle = async () => {
                try { await auth.signInWithPopup(googleProvider); } 
                catch(e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + e.message); }
            };

            const logout = async () => {
                if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) await auth.signOut();
            };

            return { user, userData, allData, loading, registerUser, saveData, loginGoogle, logout };
        };

        // 4. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç¾¤

        // Login Screen
        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen brand-gradient flex flex-col items-center justify-center p-6 text-white animate-fade-in">
                <div className="bg-white/10 backdrop-blur-lg p-10 rounded-3xl border border-white/20 shadow-2xl max-w-sm w-full text-center">
                    <h1 className="text-3xl font-black mb-2">TimeWellth</h1>
                    <p className="text-blue-100 mb-8 text-sm">ã‚ãªãŸã®è¡Œå‹•ã‚’è³‡ç”£ã«å¤‰ãˆã‚‹</p>
                    <button onClick={onLogin} className="w-full bg-white text-gray-700 font-bold py-3 rounded-xl shadow-lg hover:bg-gray-50 transition transform hover:scale-105 flex items-center justify-center gap-3">
                        <i className="fab fa-google"></i> Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                    <p className="mt-4 text-xs text-blue-200">â€»PCãƒ»ã‚¹ãƒãƒ›é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã§ãã¾ã™</p>
                </div>
            </div>
        );

        // Setup Screen
        const SetupScreen = ({ onSetup }) => {
            const [name, setName] = useState("");
            return (
                <div className="min-h-screen brand-gradient flex flex-col items-center justify-center p-6 text-white animate-fade-in">
                    <div className="bg-white/10 backdrop-blur-lg p-10 rounded-3xl border border-white/20 shadow-2xl max-w-sm w-full text-center">
                        <h1 className="text-3xl font-black mb-2">Welcome</h1>
                        <p className="text-blue-100 mb-8 text-sm">ã¯ã˜ã‚ã«ã€ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„</p>
                        <div className="space-y-4 text-left">
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-black/20 border border-white/30 rounded-lg p-3 text-white placeholder-blue-200/50 outline-none" placeholder="ä¾‹: å±±ç”° å¤ªéƒ" />
                            <button onClick={() => name && onSetup(name)} disabled={!name} className="w-full bg-white text-blue-900 font-bold py-3 rounded-xl shadow-lg hover:bg-blue-50 transition mt-4 disabled:opacity-50">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                        </div>
                    </div>
                </div>
            );
        };

        // Analytics Modal
        const AnalyticsModal = ({ onClose, allData, viewDate }) => {
            const [activeTab, setActiveTab] = useState('week'); 
            const canvasRef = useRef(null); const chartInstance = useRef(null);

            const stats = useMemo(() => {
                const result = {}; CATEGORIES.forEach(c => result[c.id] = 0);
                let startDate, endDate;
                if (activeTab === 'week') {
                    const today = new Date(); const day = today.getDay();
                    startDate = new Date(today); startDate.setDate(today.getDate() - day); 
                    endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); 
                } else {
                    startDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
                    endDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0);
                }
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dStr = formatDate(d); const dayData = allData[dStr];
                    if (dayData && dayData.actuals) {
                        Object.values(dayData.actuals).forEach(item => { if (result[item.cat] !== undefined) result[item.cat] += 0.5; });
                    }
                }
                return result;
            }, [activeTab, allData, viewDate]);

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const dataValues = Object.values(stats); const labels = CATEGORIES.map(c => c.name); const colors = CATEGORIES.map(c => c.code);
                    const filteredData = [], filteredLabels = [], filteredColors = [];
                    dataValues.forEach((val, i) => { if (val > 0) { filteredData.push(val); filteredLabels.push(labels[i]); filteredColors.push(colors[i]); } });
                    const ctx = canvasRef.current.getContext('2d');
                    if (filteredData.length === 0) { ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height); return; }
                    chartInstance.current = new Chart(ctx, { type: 'doughnut', data: { labels: filteredLabels, datasets: [{ data: filteredData, backgroundColor: filteredColors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${c.label}: ${c.raw}h` } } }, cutout: '60%' } });
                }
            }, [stats]);

            const totalHours = Object.values(stats).reduce((a, b) => a + b, 0);
            const exportAnalysisCSV = () => {
                let csvContent = "\uFEFFé›†è¨ˆæœŸé–“,ã‚«ãƒ†ã‚´ãƒªãƒ¼,åˆè¨ˆæ™‚é–“(h),æ§‹æˆæ¯”(%)\n";
                const periodLabel = activeTab === 'week' ? "ä»Šé€±" : `${viewDate.getFullYear()}å¹´${viewDate.getMonth()+1}æœˆ`;
                CATEGORIES.forEach(cat => { const hours = stats[cat.id]; if (hours > 0) { const percent = Math.round((hours / totalHours) * 100); csvContent += `${periodLabel},${cat.name},${hours},${percent}\n`; } });
                if (totalHours === 0) { alert("é›†è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
                const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csvContent); link.download = `timewealth_analysis_${activeTab}_${getTodayFullDate()}.csv`; document.body.appendChild(link); link.click();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end md:items-center justify-center z-50">
                    <div className="bg-white w-full max-w-md md:max-w-lg rounded-t-2xl md:rounded-2xl p-6 animate-slide-up max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-gray-700">ğŸ“Š åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h3><button onClick={onClose} className="bg-gray-100 w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200">Ã—</button></div>
                        <div className="flex bg-gray-100 p-1 rounded-lg mb-6">
                            <button onClick={() => setActiveTab('week')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${activeTab === 'week' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}>ä»Šé€±</button>
                            <button onClick={() => setActiveTab('month')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${activeTab === 'month' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}>{viewDate.getMonth()+1}æœˆåº¦</button>
                        </div>
                        <div className="relative h-48 w-full flex justify-center items-center mb-6">{totalHours > 0 ? (<><canvas ref={canvasRef}></canvas><div className="absolute text-center"><p className="text-xs text-gray-400">Total</p><p className="text-2xl font-bold">{totalHours}<span className="text-sm">h</span></p></div></>) : (<p className="text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</p>)}</div>
                        <div className="space-y-2 overflow-y-auto flex-1 mb-4">
                            {CATEGORIES.map(cat => {
                                const hours = stats[cat.id]; if (hours === 0) return null; const percent = Math.round((hours / totalHours) * 100);
                                return (<div key={cat.id} className="flex items-center justify-between p-2 hover:bg-gray-50 rounded"><div className="flex items-center gap-2"><div className={`w-3 h-3 rounded-full ${cat.color}`}></div><span className="text-sm font-medium">{cat.name}</span></div><div className="text-right"><span className="font-bold mr-2">{hours}h</span><span className="text-xs text-gray-400">({percent}%)</span></div></div>);
                            })}
                        </div>
                        <button onClick={exportAnalysisCSV} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold">CSVå‡ºåŠ›</button>
                    </div>
                </div>
            );
        };

        // Home Screen (ä¿®æ­£: æ—¥æ•°è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´)
        const HomeScreen = ({ user, todayStr, allData }) => {
            // â˜…ãƒã‚°ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å†…ã®totalDaysã§ã¯ãªãã€å®Ÿéš›ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿(allData)ã‹ã‚‰æ—¥æ•°ã‚’æ•°ãˆã‚‹
            const totalLogs = useMemo(() => {
                if (!allData) return 0;
                // ã‚­ãƒ¼ï¼ˆæ—¥ä»˜ï¼‰ã®ä¸­ã§ã€å®Ÿç¸¾(actuals)ãŒ1ã¤ã§ã‚‚å…¥ã£ã¦ã„ã‚‹æ—¥ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                return Object.keys(allData).filter(dateKey => {
                    const day = allData[dateKey];
                    return day.actuals && Object.keys(day.actuals).length > 0;
                }).length;
            }, [allData]);

            const rank = getRankInfo(totalLogs);

            return (
                <div className="p-4 pb-24 md:p-8 animate-fade-in max-w-5xl mx-auto w-full">
                    <div className={`rounded-2xl p-6 md:p-10 text-white shadow-xl mb-8 relative overflow-hidden ${rank.id === 'gold' ? 'bg-gradient-to-br from-yellow-600 to-yellow-400' : 'brand-gradient'}`}>
                        <div className="absolute top-0 right-0 p-4 opacity-10 text-6xl md:text-9xl"><i className="fas fa-chart-line"></i></div>
                        <div className="flex flex-col md:flex-row justify-between items-start gap-6 relative z-10">
                            <div><h2 className="text-2xl font-bold mb-2">ã“ã‚“ã«ã¡ã¯ã€{user.name}ã•ã‚“</h2><p className="text-white/90 text-sm font-medium">{getDisplayDate(todayStr)} | è¨˜éŒ²ã‚’ç©ã¿é‡ã­ã¾ã—ã‚‡ã†ã€‚</p></div>
                            <div className="bg-white/95 backdrop-blur rounded-xl p-5 text-gray-800 shadow-lg w-full md:w-80">
                                <div className="flex justify-between items-center mb-2"><span className="text-[10px] font-bold text-gray-400 tracking-wider">CURRENT RANK</span><span className="text-[10px] font-bold text-gray-400 tracking-wider">TOTAL LOGS</span></div>
                                <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><span className="text-3xl">{rank.icon}</span><span className={`text-2xl font-black ${rank.text}`}>{rank.name}</span></div><div className="text-right"><span className="text-3xl font-bold">{totalLogs}</span><span className="text-xs text-gray-500 font-bold"> days</span></div></div>
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100"><p className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wide">Rank</p><p className="text-2xl font-bold text-slate-700">{rank.name}</p></div>
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100"><p className="text-xs text-slate-400 font-bold mb-1 uppercase tracking-wide">Total Logs</p><p className="text-2xl font-bold text-slate-700">{totalLogs} <span className="text-xs text-slate-400">days</span></p></div>
                    </div>
                </div>
            );
        };

        // Daily Screen
        const DailyScreen = ({ user, currentDate, setCurrentDate, allData, setAllData, onSlotClick, onSaveReflection, isReflectOpen, setIsReflectOpen }) => {
            const chartRef = useRef(null); const canvasRef = useRef(null); const scrollRef = useRef(null);
            const [currentTimePosition, setCurrentTimePosition] = useState(null);
            const dayData = allData[currentDate] || { actuals: {}, plans: {}, reflection: { am: "", pm: "" } };
            const { actuals, plans, reflection } = dayData;
            const [localAm, setLocalAm] = useState(reflection.am || "");
            const [localPm, setLocalPm] = useState(reflection.pm || "");

            useEffect(() => { setLocalAm(reflection.am || ""); setLocalPm(reflection.pm || ""); }, [currentDate, allData]);
            useEffect(() => { if (canvasRef.current) { if (chartRef.current) chartRef.current.destroy(); const counts = {}; CATEGORIES.forEach(c => counts[c.name] = 0); Object.values(actuals).forEach(item => { const cat = CATEGORIES.find(c => c.id === item.cat); if (cat) counts[cat.name] += 30; }); const ctx = canvasRef.current.getContext('2d'); chartRef.current = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(counts).map(k => k.substring(0,4)), datasets: [{ label: 'æ™‚é–“(åˆ†)', data: Object.values(counts), backgroundColor: CATEGORIES.map(c => c.code), borderRadius: 4, barThickness: 20 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: true, grid: {display: false} }, y: { display: true, beginAtZero: true } } } }); } }, [actuals]);
            useEffect(() => { const updatePos = () => { const now = new Date(); if (formatDate(now) !== currentDate) { setCurrentTimePosition(null); return; } const h = now.getHours(); const m = now.getMinutes(); if(h < 8 || h > 22) { setCurrentTimePosition(null); return; } setCurrentTimePosition(((h - 8) * 60 + m) * (56 / 30) + 36); }; updatePos(); const timer = setInterval(updatePos, 60000); return () => clearInterval(timer); }, [currentDate]);
            useEffect(() => { if (currentTimePosition && scrollRef.current) scrollRef.current.scrollTop = currentTimePosition - 200; }, [currentTimePosition]);

            const changeDate = (diff) => { const d = new Date(currentDate); d.setDate(d.getDate() + diff); setCurrentDate(formatDate(d)); };
            const exportCSV = () => { let csvContent = "\uFEFFæ—¥ä»˜,ç¤¾å“¡å,æ™‚é–“å¸¯,ã‚«ãƒ†ã‚´ãƒªãƒ¼,å†…å®¹è©³ç´°,AMæŒ¯ã‚Šè¿”ã‚Š,PMæŒ¯ã‚Šè¿”ã‚Š\n"; const sortedTimes = TIME_SLOTS.filter(t => actuals[t]); if (sortedTimes.length === 0) { alert("ã“ã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“"); return; } sortedTimes.forEach(time => { const rec = actuals[time]; const cat = CATEGORIES.find(c => c.id === rec.cat); const safeText = `"${rec.text.replace(/"/g, '""')}"`; const safeAM = `"${localAm.replace(/"/g, '""').replace(/\n/g, ' ')}"`; const safePM = `"${localPm.replace(/"/g, '""').replace(/\n/g, ' ')}"`; csvContent += `${currentDate},${user.name},${time},${cat ? cat.name : "ä¸æ˜"},${safeText},${safeAM},${safePM}\n`; }); const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csvContent); link.download = `timewealth_${user.name}_${currentDate}.csv`; document.body.appendChild(link); link.click(); };
            const clearActuals = () => { if (window.confirm("ã“ã®æ—¥ã®å®Ÿç¸¾ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { const newData = { ...allData }; if (newData[currentDate]) { newData[currentDate].actuals = {}; setAllData(newData); } } };
            const handleReflectionSave = () => { onSaveReflection(localAm, localPm); setIsReflectOpen(false); };

            return (
                <div className="flex flex-col h-full relative">
                    <div className="flex items-center justify-between bg-white p-3 border-b shadow-sm z-30 shrink-0"><button onClick={() => changeDate(-1)} className="text-gray-500 hover:bg-gray-100 p-2 rounded"><i className="fas fa-chevron-left"></i> å‰æ—¥</button><h2 className="font-bold text-lg text-gray-800">{getDisplayDate(currentDate)}</h2><button onClick={() => changeDate(1)} className="text-gray-500 hover:bg-gray-100 p-2 rounded">ç¿Œæ—¥ <i className="fas fa-chevron-right"></i></button></div>
                    <div className="bg-white p-4 shadow-sm border-b z-10 shrink-0 h-48 md:h-64"><canvas ref={canvasRef}></canvas></div>
                    <div className="flex-1 overflow-y-auto relative bg-[#f8fafc]" ref={scrollRef}>
                        {currentTimePosition && <div className="current-time-line" style={{ top: `${currentTimePosition}px` }}><div className="absolute left-0 top-[-5px] w-2 h-2 bg-red-500 rounded-full"></div></div>}
                        <div className="flex text-xs md:text-sm font-bold text-gray-500 bg-gray-50 py-3 sticky top-0 z-10 border-b"><div className="w-12 md:w-20 text-center">Time</div><div className="flex-1 text-center">Plan</div><div className="flex-1 text-center">Actual</div></div>
                        {TIME_SLOTS.map(time => (
                            <div key={time} className="flex border-b border-gray-200 h-14 bg-white relative hover:bg-gray-50 transition">
                                <div className="w-12 md:w-20 text-xs md:text-sm text-gray-400 flex justify-center items-start pt-1 border-r border-gray-100 bg-gray-50 shrink-0">{time}</div>
                                <div className="flex-1 p-1 border-r border-gray-100 cursor-pointer relative group" onClick={() => onSlotClick(time, 'plan')}>{plans[time] ? <div className={`h-full rounded px-2 py-1 text-[10px] md:text-xs text-white leading-tight flex items-center ${CATEGORIES.find(c=>c.id===plans[time].cat)?.color}`}>{plans[time].text}</div> : <div className="h-full flex items-center justify-center text-gray-100 text-lg group-hover:text-gray-300 transition">+</div>}</div>
                                <div className="flex-1 p-1 cursor-pointer relative group" onClick={() => onSlotClick(time, 'actual')}>{actuals[time] ? <div className={`h-full rounded px-2 py-1 text-[10px] md:text-xs text-white leading-tight flex items-center ${CATEGORIES.find(c=>c.id===actuals[time].cat)?.color}`}>{actuals[time].text}</div> : <div className="h-full flex items-center justify-center text-gray-100 text-lg group-hover:text-gray-300 transition">+</div>}</div>
                            </div>
                        ))}
                        <div className="h-24"></div>
                    </div>
                    <div className="absolute bottom-6 right-6 md:bottom-10 md:right-10 flex flex-col gap-3 items-end z-30">
                        <button onClick={clearActuals} className="bg-white text-gray-400 border border-gray-200 rounded-full w-10 h-10 shadow-md flex items-center justify-center hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition"><i className="fas fa-trash-alt text-sm"></i></button>
                        <button onClick={exportCSV} className="bg-white text-green-600 border border-green-200 rounded-full w-12 h-12 shadow-lg flex items-center justify-center hover:bg-green-50 transition"><i className="fas fa-file-csv text-xl"></i></button>
                        <button onClick={() => setIsReflectOpen(true)} className="bg-blue-600 text-white rounded-full px-6 py-4 shadow-lg font-bold flex items-center gap-2 hover:bg-blue-700 transition transform hover:scale-105"><i className="fas fa-edit"></i> æ—¥å ±</button>
                    </div>
                    {isReflectOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end md:items-center justify-center">
                            <div className="bg-white w-full max-w-md md:max-w-lg rounded-t-2xl md:rounded-2xl p-6 animate-slide-up max-h-[85vh] overflow-y-auto shadow-2xl">
                                <div className="flex justify-between items-center mb-6 border-b pb-2"><h3 className="font-bold text-xl text-gray-700">ğŸ“ æ—¥å ±</h3><button onClick={() => setIsReflectOpen(false)} className="bg-gray-100 w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200">Ã—</button></div>
                                <div className="space-y-5">
                                    <div><label className="text-sm font-bold text-blue-600 block mb-2">â˜€ï¸ AM æŒ¯ã‚Šè¿”ã‚Š</label><textarea className="w-full text-sm p-3 rounded-lg border border-blue-200 bg-blue-50 focus:ring-2 focus:ring-blue-500 outline-none" rows="3" value={localAm} onChange={(e) => setLocalAm(e.target.value)}></textarea></div>
                                    <div><label className="text-sm font-bold text-indigo-600 block mb-2">ğŸŒ™ PM ç·æ‹¬</label><textarea className="w-full text-sm p-3 rounded-lg border border-indigo-200 bg-indigo-50 focus:ring-2 focus:ring-indigo-500 outline-none" rows="4" value={localPm} onChange={(e) => setLocalPm(e.target.value)}></textarea></div>
                                    <button onClick={handleReflectionSave} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold mt-2 hover:bg-slate-900 transition">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryScreen = ({ currentDate, setCurrentDate, allData, onSelectDate }) => {
            const [viewDate, setViewDate] = useState(new Date(currentDate));
            const [showAnalytics, setShowAnalytics] = useState(false);
            const generateCalendar = () => { const year = viewDate.getFullYear(); const month = viewDate.getMonth(); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const days = []; for (let i = 0; i < firstDay.getDay(); i++) { days.push(null); } for (let i = 1; i <= lastDay.getDate(); i++) { days.push(new Date(year, month, i)); } return days; };
            const calendarDays = generateCalendar();
            const changeMonth = (diff) => { const d = new Date(viewDate); d.setMonth(d.getMonth() + diff); setViewDate(d); };

            return (
                <div className="p-4 pb-24 md:p-8 animate-fade-in max-w-5xl mx-auto w-full">
                    <div className="flex justify-between items-end mb-4"><h2 className="font-bold text-gray-700 text-xl">éå»ã®å±¥æ­´</h2><button onClick={() => setShowAnalytics(true)} className="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full text-sm font-bold shadow-sm hover:bg-indigo-100 transition"><i className="fas fa-chart-pie mr-2"></i>åˆ†æ</button></div>
                    <div className="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
                        <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">{viewDate.getFullYear()}å¹´ {viewDate.getMonth() + 1}æœˆ</h3><div className="flex gap-2 text-gray-500"><button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded"><i className="fas fa-chevron-left"></i></button><button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded"><i className="fas fa-chevron-right"></i></button></div></div>
                        <div className="grid grid-cols-7 gap-2 text-center text-sm mb-2 text-gray-400 font-bold"><div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div></div>
                        <div className="grid grid-cols-7 gap-2 text-center text-sm">
                            {calendarDays.map((date, i) => {
                                if (!date) return <div key={i}></div>;
                                const dateStr = formatDate(date);
                                const hasData = allData[dateStr] && Object.keys(allData[dateStr].actuals).length > 0;
                                const isSelected = dateStr === currentDate;
                                return (<div key={i} onClick={() => onSelectDate(dateStr)} className={`h-12 md:h-16 flex flex-col items-center justify-center rounded-lg transition cursor-pointer border ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-transparent hover:border-gray-200 hover:bg-gray-50'}`}><span className={`text-sm ${isSelected ? 'font-bold text-blue-600' : 'text-gray-600'}`}>{date.getDate()}</span>{hasData && <div className="flex gap-0.5 mt-1"><div className="w-1.5 h-1.5 rounded-full bg-green-400"></div></div>}</div>);
                            })}
                        </div>
                    </div>
                    {showAnalytics && <AnalyticsModal onClose={() => setShowAnalytics(false)} allData={allData} viewDate={viewDate} />}
                </div>
            );
        };

        // 5. App æœ¬ä½“
        const App = () => {
            const { user, userData, allData, loading, registerUser, saveData, loginGoogle, logout } = useFirebaseData();
            const [view, setView] = useState('home');
            const [currentDate, setCurrentDate] = useState(formatDate(new Date()));

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedTime, setSelectedTime] = useState(null);
            const [inputType, setInputType] = useState(null);
            const [inputText, setInputText] = useState("");
            const [isReflectOpen, setIsReflectOpen] = useState(false);

            if (loading) return <div style={{height:'100vh', display:'flex', alignItems:'center', justifyContent:'center'}}>Loading...</div>;
            
            // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰Googleãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
            if (!user) return <LoginScreen onLogin={loginGoogle} />;
            
            // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã ãŒåå‰ç™»éŒ²ãŒã¾ã ãªã‚‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢
            if (!userData) return <SetupScreen onSetup={registerUser} />;

            const updateDayData = (date, key, value) => {
                const dayData = allData[date] || { plans: {}, actuals: {}, reflection: { am: "", pm: "" } };
                const newDayData = { ...dayData, [key]: value };
                const newAllData = { ...allData, [date]: newDayData };
                saveData(newAllData);
            };

            const handleSave = (catId) => {
                const textToSave = inputText.trim() === "" ? CATEGORIES.find(c => c.id === catId).name : inputText;
                const data = { text: textToSave, cat: catId };
                const dayData = allData[currentDate] || { plans: {}, actuals: {}, reflection: {} };
                if (inputType === 'plan') { updateDayData(currentDate, 'plans', { ...dayData.plans, [selectedTime]: data }); } 
                else { updateDayData(currentDate, 'actuals', { ...dayData.actuals, [selectedTime]: data }); }
                setIsModalOpen(false); setInputText("");
            };

            const handleSlotClick = (time, type) => {
                setSelectedTime(time); setInputType(type);
                const dayData = allData[currentDate] || { plans: {}, actuals: {} };
                const cur = dayData[type === 'plan' ? 'plans' : 'actuals']?.[time];
                setInputText(cur ? cur.text : "");
                setIsModalOpen(true);
            };

            const handleSaveReflection = (am, pm) => { updateDayData(currentDate, 'reflection', { am, pm }); };
            const handleSelectDate = (dateStr) => { setCurrentDate(dateStr); setView('daily'); };

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    <div className={`text-white p-4 flex justify-between items-center shrink-0 z-40 shadow-md brand-gradient`}>
                        <div className="flex items-center gap-3"><h1 className="font-bold text-lg">TimeWellth <span className="text-xs opacity-70">Cloud</span></h1></div>
                        <button onClick={logout} className="text-[10px] md:text-xs bg-white/20 px-3 py-1.5 rounded text-white/90 hover:bg-white/30 transition border border-white/10">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                    <div className="flex flex-1 overflow-hidden relative w-full bg-[#f8fafc] md:flex-row flex-col">
                        <div className="hidden md:flex w-64 bg-white border-r flex-col shrink-0 z-30 p-4 gap-2">
                            <button onClick={() => setView('home')} className={`p-2 text-left font-bold rounded ${view==='home' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-100'}`}>ãƒ›ãƒ¼ãƒ </button>
                            <button onClick={() => { setCurrentDate(formatDate(new Date())); setView('daily'); }} className={`p-2 text-left font-bold rounded ${view==='daily' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-100'}`}>è¡Œå‹•è¨˜éŒ²</button>
                            <button onClick={() => setView('history')} className={`p-2 text-left font-bold rounded ${view==='history' ? 'text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-100'}`}>å±¥æ­´</button>
                        </div>
                        <div className="flex-1 overflow-y-auto w-full h-full">
                            {view === 'home' && <HomeScreen user={userData} todayStr={formatDate(new Date())} allData={allData} />}
                            {view === 'daily' && (
                                <DailyScreen 
                                    user={userData} currentDate={currentDate} setCurrentDate={setCurrentDate}
                                    allData={allData} setAllData={(d)=>saveData(d)}
                                    onSlotClick={handleSlotClick} onSaveReflection={handleSaveReflection}
                                    isReflectOpen={isReflectOpen} setIsReflectOpen={setIsReflectOpen}
                                />
                            )}
                            {view === 'history' && <HistoryScreen currentDate={currentDate} setCurrentDate={setCurrentDate} allData={allData} onSelectDate={handleSelectDate} />}
                        </div>
                    </div>
                    <div className="md:hidden shrink-0 bg-white border-t border-gray-200 flex justify-around py-2 pb-safe z-40">
                        <button onClick={() => setView('home')} className={`flex flex-col items-center p-2 flex-1 ${view === 'home' ? 'text-blue-600' : 'text-gray-400'}`}><i className="fas fa-home text-xl mb-1"></i><span className="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span></button>
                        <button onClick={() => { setCurrentDate(formatDate(new Date())); setView('daily'); }} className={`flex flex-col items-center p-2 flex-1 ${view === 'daily' ? 'text-blue-600' : 'text-gray-400'}`}><i className="fas fa-calendar-day text-xl mb-1"></i><span className="text-[10px] font-bold">è¡Œå‹•è¨˜éŒ²</span></button>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center p-2 flex-1 ${view === 'history' ? 'text-blue-600' : 'text-gray-400'}`}><i className="fas fa-history text-xl mb-1"></i><span className="text-[10px] font-bold">å±¥æ­´</span></button>
                    </div>
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end md:items-center justify-center z-50">
                            <div className="bg-white w-full max-w-md md:max-w-lg rounded-t-2xl md:rounded-2xl p-5 animate-slide-up shadow-2xl">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-700">{selectedTime} ã®{inputType === 'plan' ? 'äºˆå®š' : 'å®Ÿç¸¾'}</h3><button onClick={() => setIsModalOpen(false)} className="bg-gray-100 w-8 h-8 rounded-full text-gray-500 hover:bg-gray-200">Ã—</button></div>
                                <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} className="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-lg mb-4 outline-none focus:ring-2 focus:ring-blue-500" placeholder="å†…å®¹ã‚’å…¥åŠ›..." autoFocus />
                                <div className="grid grid-cols-3 gap-2">{CATEGORIES.map(cat => <button key={cat.id} onClick={() => handleSave(cat.id)} className={`${cat.color} text-white py-3 rounded-lg text-xs font-bold shadow-sm active:scale-95 transition flex flex-col items-center justify-center hover:opacity-90`}>{cat.name}</button>)}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>